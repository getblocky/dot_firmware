<!doctype html>
<html>
<head>
<meta charset=utf-8>
<meta name=viewport content='width=380'>
<title>Connect Blocky to you WiFi</title>
<style media=screen type=text/css>*{margin:0;padding:0}html{height:100%;background:linear-gradient(rgba(196,102,0,0.2),rgba(155,89,182,0.2)),url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAAA8AgMAAACm+SSwAAAADFBMVEVBR1FFS1VHTlg8Q0zU/YXIAAADVElEQVQ4yy1TTYvTUBQ9GTKiYNoodsCF4MK6U4TZChOhiguFWHyBFzqlLl4hoeNvEBeCrlrhBVKq1EUKLTP+hvi1GyguXqBdiZCBzGqg20K8L3hDQnK55+OeJNguHx6UujYl3dL5ALn4JOIUluAqeAWciyGaSdvngOWzNT+G0UyGUOxVOAdqkjXDCbBiUyjZ5QzYEbGadYAi6kHxth+kthXNVNCDofwhGv1D4QGGiM9iAjbCHgr2iUUpDJbs+VPQ4xAr2fX7KXbkOJMdok965Ksb+6lrjdkem8AshIuHm9Nyu19uTunYlOXDTQqi8VgeH0kBXH2xq/ouiMZPzuMukymutrBmulUTovC6HqNFW2ZOiqlpSXZOTvSUeUPxChjxol8BLbRy4gJuhV7OR4LRVBs3WQ9VVAU7SXgK2HeUrOj7bC8YsUgr3lEV/TXB7hK90EBnxaeg1Ov15bY80M736ekCGesGAaGvG0Ct4WRkVQVHIgIM9xJgvSFfPay8Q6GNv7VpR7xUnkvhnMQCJDYkYOtNLihV70tCU1Sk+BQrpoP+HLHUrJkuta40C6LP5GvBv+Hqo10ATxxFrTPvNdPr7XwgQud6RvQN/sXjBGzqbU27wcj9cgsyvSTrpyXV8gKpXeNJU3aFl7MOdldzV4+HfO19jBa5f2IjWwx1OLHIvFHkqbBj20ro1g7nDfY1DpScvDRUNARgjMMVO0zoMjKxJ6uWCPP+YRAWbGoaN8kXYHmLjB9FXLGOazfFVCvOgqzfnicNPrHtPKlex2ye824gMza0cTZ2sS2Xm7Qst/UfFw8O6vVtmUKxZy9xFgzMys5cJ5fxZw4y37Ufk1Dsfb8MqOjYxE3ZMWxiDcO0PYUaD2ys+8OW1pbB7/e3sfZeGVCL0Q2aMjjPdm2sxADuejZxHJAd8dO9DSUdA0V8/NggRRanDkBrANn8yHlEQOn/MmwoQfQF7xgmKDnv520bS/pgylP67vf3y2V5sCwfoCEMkZClgOfJAFX9eXefR2RpnmRs4CDVPceaRfoFzCkJVJX27vWZnoqyvmtXU3+dW1EIXIu8Qg5Qta4Zlv7drUCoWe8/8MXzaEwux7ESE9h6qnHj3mIO0/D9RvzfxPmjWiQ1vbeSk4rrHwhAre35EEVaAAAAAElFTkSuQmCC)}body{font-family:arial,verdana}div{position:absolute;margin:auto;top:0;right:0;bottom:0;left:0;width:320px;height:274px}form{width:320px;text-align:center;position:relative}form fieldset{background:white;border:0 none;border-radius:5px;box-shadow:0 0 15px 1px rgba(0,0,0,0.4);padding:20px 30px;box-sizing:border-box}form input{padding:15px;border:1px solid #ccc;border-radius:3px;margin-bottom:10px;width:100%;box-sizing:border-box;font-family:montserrat;color:#2c3e50;font-size:13px}form select{padding:15px;border:1px solid #ccc;border-radius:3px;margin-bottom:10px;width:100%;box-sizing:border-box;font-family:montserrat;color:#2c3e50;font-size:13px}form .action-button{width:100px;background:#27ae60;font-weight:bold;color:white;border:0 none;border-radius:3px;cursor:pointer;padding:10px 5px;margin:10px 5px}form .action-button:hover,#msform .action-button:focus{box-shadow:0 0 0 2px white,0 0 0 3px #27ae60}.fs-title{font-size:15px;text-transform:uppercase;color:#2c3e50;margin-bottom:10px}.fs-subtitle{font-weight:normal;font-size:13px;color:#666;margin-bottom:20px}.loader{border:10px solid #f3f3f3;border-radius:50%;border-top:10px solid #3498db;width:10px;height:10px;-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg)}}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
<script type=text/javascript>
	function loadAPs() {
		var a = new XMLHttpRequest();
		a.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var b = JSON.parse(this.responseText);
				for (var d in b) {
					var c = document.createElement("option");
					c.text = b[d].ssid;
					c.value = b[d].ssid;
					document.getElementById("apslist").options.add(c)
				}
			}
			document.getElementById("loaderDiv").style.visibility = "hidden"
		};
		a.open("GET", "/aplist", true);
		a.send()
	}
	var checkStatusTimer = null;

	function checkStatus() {
		var a = new XMLHttpRequest();
		a.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				if (this.responseText == "OK") {
					clearInterval(checkStatusTimer);
					document.getElementById("loaderDiv").style.visibility = "hidden";
					document.getElementById("loaderLabel").innerText = "WIFI setup is done. Your Blocky will reboot. You now can close this page.";
					document.getElementsByName("ssid")[0].style.display = "none";
					document.getElementsByName("password")[0].style.display = "none";
					document.getElementsByName("token")[0].style.display = "none";
					document.getElementById("submit").style.display = "none"
				} else {
					if (this.responseText == "Failed") {
						clearInterval(checkStatusTimer);
						document.getElementById("form").disabled = false;
						document.getElementById("loaderDiv").style.visibility = "hidden";
						document.getElementById("loaderLabel").innerText = "Failed to connect. Try again please."
					}
				}
			}
		};
		a.open("GET", "/status", true);
		a.send()
	}

	function save() {
		document.getElementById("form").disabled = false;
		document.getElementById("loaderDiv").style.visibility = "visible";
		document.getElementById("loaderLabel").innerText = "Connecting to the selected WIFI network";
		var a = new XMLHttpRequest();
		a.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				checkStatusTimer = setInterval(checkStatus, 1000)
			}
		};
		a.open("POST", "/save", true);
		a.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		a.send(JSON.stringify({
			ssid: document.getElementsByName("ssid")[0].value,
			password: document.getElementsByName("password")[0].value,
			token: document.getElementsByName("token")[0].value,
		}))
	};

</script>
</head>
<body onload=loadAPs()>
<div>
<form id=form>
<fieldset>
<h2 class=fs-title>Blocky Configuration</h2>
<h3 class=fs-subtitle id=loaderLabel>Select your Wi-Fi network</h3>
<select id=apslist name=ssid placeholder='WiFi Name'>
<option value></option>
</select>
<input type=password name=password placeholder=Password />
<input type=text autocorrect=off autocapitalize=none name=token placeholder='Authentication Key' />
<input type=button id=submit class='submit action-button' value=Submit onclick=save() />
</fieldset>
</form>
<div class=loader id=loaderDiv style=visibility:visible></div>
</div>
</body>
</html>